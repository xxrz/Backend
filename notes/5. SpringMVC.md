# SpringMVC

## 1. 定义

- 什么是MVC？

  MVC是model（模型）、view（视图）、controller（控制器）的缩写。是将**业务逻辑、数据、显示**分离的一种架构模式。其中，

  - model（dao、service）：数据模型，提供了**模型数据的查询和数据状态更新**等功能，包含数据和行为
  - view（jsp）：对**模型结果的展示**，即用户界面所看见的结果
  - controller（servlet）：负责**接受用户请求，将请求交给模型进行处理，并将处理的结果返回给视图，再由视图进行展示**。

  **最典型的MVC就是JSP + servlet + javabean的模式**

  ![image-20220428002153382](appendix\5. SpringMVC\image-20220428002153382.png)

- 什么是SpringMVC？

  - 基于Java实现MVC轻量级的Web框架，其核心是**DispatcherServlet**，其作用是将不同的请求分发到不同的处理器。**降低了视图与业务逻辑间的双向偶合**

  - MVC不是一种设计模式，**MVC是一种架构模式**

  [官方文档链接](https://docs.spring.io/spring/docs/5.2.0.RELEASE/spring-framework-reference/web.html#spring-web)
  
- **MVC框架要做哪些事情**

  1. 将url映射到java类或java类的方法 .
  2. 封装用户提交的数据 .
  3. 处理请求--调用相关的业务处理--封装响应数据 .
  4. 将响应的数据进行渲染 . jsp / html 等表示层数据 .



## 2.原理

> servlet转发和重定向的区别
>
> 前端 数据传输 实体类
>
> 实体类：用户名，密码，生日，爱好..
>
> 前端 ：用户名 密码
>
> 
>
> pojo：User（实体类所有属性）
>
> vo：（视图对象）UserVo（用户名 密码）
>
> dto：（数据传输对象）

#### SpringMVC简易原理

当发起请求时被前置的控制器拦截到请求，根据请求参数生成代理请求，找到请求对应的实际控制器，控制器处理请求，创建数据模型，访问数据库，将模型响应给中心控制器，控制器使用模型与视图渲染视图结果，将结果返回给中心控制器，再将结果返回给请求者。

![image-20220428002641869](appendix\5. SpringMVC\image-20220428002641869.png)

#### SpringMVC详细原理

![image-20220428002843523](appendix\5. SpringMVC\image-20220428002843523.png)

图为SpringMVC的一个较完整的流程图，实线表示SpringMVC框架提供的技术，不需要开发者实现，虚线表示需要开发者实现。

**简要分析执行流程**

- **接受并拦截请求**

1. DispatcherServlet表示前置控制器，是整个SpringMVC的控制中心。用户发出请求，DispatcherServlet接收请求并拦截请求。

> 假设请求的url为 : http://localhost:8080/SpringMVC/test
>
> ​	服务器域名：http://localhost:8080
> ​	服务器上的web站点：SpringMVC
> ​	控制器名：test
>
> 如上url表示为：请求位于服务器localhost:8080上的SpringMVC站点的hello控制器。

- **解析url，找到url对应的控制器，并返回给DispatcherServlet**

2. HandlerMapping为处理器映射。DispatcherServlet调用HandlerMapping,HandlerMapping根据请求url查找Handler。
3. HandlerExecution表示具体的Handler,其主要作用是根据url查找控制器，如上url被查找控制器为：hello。
4. HandlerExecution将解析后的信息传递给DispatcherServlet,如解析控制器映射等。

- **对应的控制器执行请求，并把结果返回给DispatcherServlet**

5. HandlerAdapter表示处理器适配器，其按照特定的规则去执行Handler。
6. Handler让具体的Controller执行。
7. Controller将具体的执行信息返回给HandlerAdapter,如ModelAndView。
8. HandlerAdapter将视图逻辑名或模型传递给DispatcherServlet。

- **视图解析器解析内容并调用对应视图**

9. DispatcherServlet调用视图解析器(ViewResolver)来解析HandlerAdapter传递的逻辑视图名。
10. 视图解析器将解析的逻辑视图名传给DispatcherServlet。
11. DispatcherServlet根据视图解析器解析的视图结果，调用具体的视图。

- **最终视图呈现给用户**。





## 3. 实现第一个MVC程序（配置版）

注：本代码为说明SpringMVC执行原理，实际上使用时多用注解，可参考下一篇文章内容[实现第一个MVC程序（注解版）](https://blog.csdn.net/weixin_44382915/article/details/115487653)。

### 3.1 引入库

创建一个maven项目，右击module名添加web框架支持，并在pom.xml文件中加入依赖。

```xml
<dependencies>
    <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
        <version>4.12</version>
    </dependency>
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-webmvc</artifactId>
        <version>5.1.8.RELEASE</version>
    </dependency>
    <dependency>
        <groupId>javax.servlet</groupId>
        <artifactId>servlet-api</artifactId>
        <version>2.5</version>
    </dependency>
    <dependency>
        <groupId>javax.servlet.jsp</groupId>
        <artifactId>jsp-api</artifactId>
        <version>2.0</version>
    </dependency>
    <dependency>
        <groupId>javax.servlet</groupId>
        <artifactId>jstl</artifactId>
        <version>1.2</version>
    </dependency>
</dependencies>

```

### 3.2 注册DispatcherServlet

在web.xml文件中注册DispatcherServlet，并关联SpringMVC的配置文件，设置servlet启动顺序。

```xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"
         version="4.0">

    <!--注册DispatcherServlet-->
    <servlet>
        <servlet-name>SpringMVC</servlet-name>
        <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>
        <!--关联SpringMVC配置文件的位置，配置文件写在resources目录下 -->
        <init-param>
            <param-name>contextConfigLocation</param-name>
            <param-value>classpath:springmvc-servlet.xml</param-value>
        </init-param>
        <!-- 启动顺序，数字越小，启动越早，1为和服务器一同启动 -->
        <load-on-startup>1</load-on-startup>
    </servlet>

    <!--所有请求都会被SpringMVC拦截，即DispatcherServlet -->
    <servlet-mapping>
        <servlet-name>SpringMVC</servlet-name>
        <url-pattern>/</url-pattern>
    </servlet-mapping>

</web-app>

```

### 3.3 配置SpringMVC配置文件

在resources目录下配置springmvc-servlet.xml配置文件。
 配置文件内容包括处理器映射器、处理器适配器、视图解析器、处理器绑定的跳转页面的bean。

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd">

    <!--处理器映射器HandlerMapping:查找访问的url-->
    <bean class="org.springframework.web.servlet.handler.BeanNameUrlHandlerMapping"/>
    
    <!--处理器适配器HandlerAdapter：controller将处理好的数据返回给HandlerAdapter-->
    <bean class="org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter"/>
    
    <!--视图解析器ViewResolver：将后端处理好的数据和视图传给DispatchServlet，DS再交给ViewResolver先解析一遍，确认无误再传给前端-->
    <bean class="org.springframework.web.servlet.view.InternalResourceViewResolver" id="internalResourceViewResolver">
        <!-- 拼接视图名称 WEB-INF/jsp/xxxxx.jsp -->
        <property name="prefix" value="/WEB-INF/jsp/" />
        <property name="suffix" value=".jsp" />
    </bean>
    
    <!--BeanNameUrlHandlerMapping处理器：绑定请求页面的url，绑定操作业务的控制器-->
    <bean id="/test" class="com.ali.HelloController"/>
</beans>

```

### 3.4 配置操作业务的控制器

```java
import org.springframework.web.servlet.ModelAndView;
import org.springframework.web.servlet.mvc.Controller;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

//controller 处理请求并返回一个ModelAndView，实现接口Controller的类就是一个控制器。
public class HelloController implements Controller {

    @Override
    public ModelAndView handleRequest(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse) throws Exception {
        ModelAndView mav = new ModelAndView();

        // 业务代码
        String result = "Hello"; // 假设这个为调用业务代码的返回值。
        mav.addObject("msg", result);

        // 视图跳转到test.jsp
        mav.setViewName("test");

        return mav;
    }
}
```

### 3.5 设置一个测试使用的视图页面

在目录WEB-INF/jsp/下建立一个测试页面test.jsp

```xml
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>Title</title>
</head>
<body>
${msg}
</body>
</html>
```

### 3.6 测试

